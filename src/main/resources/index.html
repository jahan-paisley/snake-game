<!doctype html>
<head>
    <meta charset="utf-8">
    <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
         Remove this if you use the .htaccess -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Snake Charm</title>
    <style type="text/css">
        #ui * {
            width: 100%;
        }

        #ui textarea {
            height: 15em;
        }

        td {
            vertical-align: top;
        }

        body {
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.16.4/lodash.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

<body>
<div id="not-supported" style="float: left; width: 600px; margin-left: 10px; display: none">
    <p>Uh-oh, the browser you're using doesn't have native support for WebSocket. That means you can't run this
        demo.</p>
    <p>The following link lists the browsers that support WebSocket:</p>
    <p><a href="http://caniuse.com/#feat=websockets">http://caniuse.com/#feat=websockets</a></p>
</div>
<table class="table">
    <tr>
        <td>
            Connect to server
            <input type="submit" class="btn" id="connect" value="Connect"/>
        </td>
        <td>
            Users:
            <select id="users" class="form-control">
            </select>
            <input type="submit" class="btn" id="play" value="Play"/>
        </td>
        <td>
            <div>Enter a message below to send</div>
            <input type="text" id="msg" class="form-control"/>
            <input type="submit" class="btn" value="Send" id="send"/>
        </td>
        <td id="ui">
            Log:
            <textarea id="log" disabled></textarea>
        </td>
    </tr>
</table>
<canvas id="canvas" tabindex="1"></canvas>
</body>
<script type="text/javascript">

    // RequestAnimFrame: a browser API for getting smooth animations
    window.requestAnimFrame = (function () {
        return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                window.oRequestAnimationFrame ||
                window.msRequestAnimationFrame ||
                function (callback) {
                    return window.setTimeout(callback, 1000 / 60);
                };
    })();
    window.cancelRequestAnimFrame = (function () {
        return window.cancelAnimationFrame ||
                window.webkitCancelRequestAnimationFrame ||
                window.mozCancelRequestAnimationFrame ||
                window.oCancelRequestAnimationFrame ||
                window.msCancelRequestAnimationFrame ||
                clearTimeout
    })();
    // Initialize canvasElm and required variables
    var canvasElm = document.getElementById("canvas"),
            canvas = canvasElm.getContext("2d");
    canvasElm.width = window.innerWidth;
    canvasElm.height = window.innerHeight / 2;

    var game = new Game(canvas);

    function Point(x, y) {
        this.x = x;
        this.y = y;

        this.next = function (direction) {
            var nextp = new Point(this.x, this.y);
            switch (direction) {
                case 'r':
                    nextp.x += 1;
                    break;
                case 'l':
                    nextp.x -= 1;
                    break;
                case 'u':
                    nextp.y -= 1;
                    break;
                case 'd':
                    nextp.y += 1;
                    break;
            }
            return nextp;
        }

        this.equals = function (b) {
            try {
                if (this.x === b.x && this.y === b.y) {
                    return true;
                }
                return false;
            }
            catch (e) {
                return false;
            }
        }
    }

    function Snake() {
        this.dots = [];
        for (var i = 0; i < 50; i++) {
            this.dots.push(new Point(0, i));
        }
        this.direction = 'd';

        this.turn = function (dir) {
            if (['r', 'l', 'u', 'd'].indexOf(dir) == -1)
                return;
            if (this.validMove(dir))
                this.direction = dir;
        };

        this.validMove = function (dir) {
            var last2p = this.dots[this.dots.length - 2];
            var lastp = this.dots[this.dots.length - 1];
            if (lastp.next(dir).equals(last2p))
                return false;
            return true;
        };

        this.move = function (canvas) {
            var lastp = this.dots[this.dots.length - 1];
            var nextp = lastp.next(this.direction);
            var fruitInx = _.findIndex(game.fruits, {x: lastp.x, y: lastp.y});
            this.dots.push(nextp);
            if (fruitInx != -1)
                game.fruits.splice(fruitInx, 1);
            else
                this.dots = this.dots.slice(1);
        };

        this.draw = function (canvas) {
            canvasElm.lineWidth = 2;
            canvas.strokeStyle = "red";
            canvas.beginPath();
            canvas.moveTo(this.dots[0].x, this.dots[0].y);
            for (var i = 0; i < this.dots.length; ++i)
                canvas.lineTo(this.dots[i].x, this.dots[i].y);
            canvas.stroke();
        }
    }

    function Game(canvas) {
        this.snake = new Snake();
        this.canvas = canvas;
        this.fruits = [];

        this.draw = function () {
            this.canvas.fillRect(0, 0, window.innerWidth, window.innerHeight / 2);
            this.snake.draw(this.canvas);
            this.snake.move(this.canvas);
            this.fillFruits();
        };

        this.fillFruits = function () {
            for (var i = 0; i < this.fruits.length; i++) {
                this.canvas.beginPath();
                this.canvas.fillStyle = "yellow";
                this.canvas.fillRect(this.fruits[i].x, this.fruits[i].y, 2, 2);
                this.canvas.fillStyle = "black";
            }
        }

        this.drawFruits = function () {
            for (var i = 0; i < 50; i++) {
                var x = Math.floor((Math.random() * window.innerWidth) + 1);
                var y = Math.floor((Math.random() * window.innerHeight / 2) + 1);
                this.fruits.push(new Point(x, y));
            }
        };

        this.drawFruits();
    }
    game.animLoop = function () {
        requestAnimFrame(game.animLoop);
        game.draw();
    };

    game.draw();

    document.addEventListener('keydown', function (event) {
        var keymap = {'37': 'l', '38': 'u', '39': 'r', '40': 'd'};
        game.snake.turn(keymap[event.keyCode.toString()]);
    }, false);
    canvasElm.addEventListener("mousedown", game.animLoop, true);

    function log(msg) {
        var log = $('#log');
        log.append(msg + " \n").scrollTop(log[0].scrollHeight - log.height());
    }

    $(function () {
        var url = "ws://" + location.host + '/ws';

        if (!WebSocket) {
            $('#not-supported').show();
        } else {
            var ws = null;
            $('#connect').click(function () {
                if (ws == null || ws.readyState != 1) {
                    ws = new WebSocket(url);
                    ws.onerror = function (e) {
                        log('Error : ' + e.message);
                    }
                    ws.onopen = function () {
                        log('connected');
                        $("#connect").prop('disabled', true)
                    }
                    ws.onclose = function () {
                        log('disconnected');
                    }
                    ws.onmessage = function (d) {
                        if (d.data.startsWith("users")) {
                            var users = d.data.split(',').slice(1);
                            if (users.length > 0) {
                                $('#users').find('option').remove();
                                _.each(users, function (user) {
                                    $('#users').append($('<option>',
                                            {
                                                value: user,
                                                text: user
                                            }))
                                });
                            }
                        }
                        else if(d.data.startsWith("game")){
                            var remoteGame = JSON.parse(d.data.split("game,")[1]);
                            game.fruits= []
                            _.each(remoteGame.fruits, function(value){
                                game.fruits.push(new Point(value.x, value.y));
                            });
                            game.draw();
                        }
                        else
                            log(d.data);
                    }
                    $('#send').click(function () {
                        var msg = $('#msg').val();
                        $('#msg').val('');
                        try {
                            if ($('#users').val()) {
                                ws.send($('#users').val() + "|" + msg);
                                log('Message sent');
                            }
                            else {
                                alert("please choose a recipient!");
                            }
                        }
                        catch (ex) {
                            log('Message not sent due to' + ex);
                        }
                    })
                }
                else {
                    log('closing connection');
                    ws.close();
                }
            });
            $('#play').click(function () {
                var opponent = $('#users').val();
                if (opponent) {
                    ws.send(opponent + "|" + "game," + JSON.stringify(game));
                }
                else
                    alert("please choose opponent!");
            });
        }
    });
</script>
</html>